import React, { useState, useEffect, useCallback } from 'react';
import {
  View,
  StyleSheet,
  FlatList,
  RefreshControl,
  Alert,
  Text,
  TouchableOpacity,
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { Searchbar, Snackbar, Portal, Modal, Button, Divider } from 'react-native-paper';
import { Ionicons } from '@expo/vector-icons';
import * as Haptics from 'expo-haptics';
import { useAppStore } from '../store/AppStore';
import { OrderCard } from '../components/OrderCard';
import { formatAmount, getPayTypeText } from '../utils/formatters';
import { darkTheme, lightTheme, spacing, borderRadius, fontSize } from '../utils/theme';

export default function HistoryScreen() {
  const {
    orders,
    refreshOrders,
    removeOrder,
    undoRemove,
    theme: themeMode,
  } = useAppStore();
  
  const theme = themeMode === 'dark' ? darkTheme : lightTheme;

  const [searchQuery, setSearchQuery] = useState('');
  const [filteredOrders, setFilteredOrders] = useState(orders);
  const [refreshing, setRefreshing] = useState(false);
  const [selectedOrder, setSelectedOrder] = useState(null);
  const [modalVisible, setModalVisible] = useState(false);
  
  // Undo —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  const [snackbarVisible, setSnackbarVisible] = useState(false);
  const [currentSnapshotId, setCurrentSnapshotId] = useState(null);

  useEffect(() => {
    handleSearch(searchQuery);
  }, [orders, searchQuery]);

  const handleSearch = (query) => {
    setSearchQuery(query);
    
    if (!query.trim()) {
      setFilteredOrders(orders);
      return;
    }

    const lowercaseQuery = query.toLowerCase();
    const filtered = orders.filter(
      (order) =>
        order.client.toLowerCase().includes(lowercaseQuery) ||
        order.car.toLowerCase().includes(lowercaseQuery) ||
        order.job.toLowerCase().includes(lowercaseQuery)
    );
    
    setFilteredOrders(filtered);
  };

  const onRefresh = useCallback(async () => {
    setRefreshing(true);
    await refreshOrders();
    setRefreshing(false);
  }, []);

  const showOrderDetails = (order) => {
    setSelectedOrder(order);
    setModalVisible(true);
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
  };

  const handleDeleteOrder = (order) => {
    Haptics.notificationAsync(Haptics.NotificationFeedbackType.Warning);
    
    Alert.alert(
      'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑?',
      `–î–∞—Ç–∞: ${order.date}\n–ö–ª–∏–µ–Ω—Ç: ${order.client}\n–°—É–º–º–∞: ${formatAmount(order.amount)}\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç.`,
      [
        {
          text: '–û—Ç–º–µ–Ω–∞',
          style: 'cancel',
        },
        {
          text: 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å',
          style: 'destructive',
          onPress: async () => {
            try {
              const deleteLinkedDebt = order.payType === 'debt';
              const result = await removeOrder(order.id, deleteLinkedDebt);
              
              setModalVisible(false);
              setCurrentSnapshotId(result.snapshotId);
              setSnackbarVisible(true);
              
              Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);
            } catch (error) {
              Alert.alert('‚ùå –û—à–∏–±–∫–∞', error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑');
              Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error);
            }
          },
        },
      ]
    );
  };

  const handleUndo = async () => {
    try {
      await undoRemove(currentSnapshotId);
      setSnackbarVisible(false);
      setCurrentSnapshotId(null);
      Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);
    } catch (error) {
      Alert.alert('‚ùå –û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–∫–∞–∑');
      Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error);
    }
  };

  const renderEmpty = () => (
    <View style={styles.emptyState}>
      <Ionicons name="document-text-outline" size={64} color={theme.textTertiary} />
      <Text style={[styles.emptyText, { color: theme.textSecondary }]}>
        {searchQuery ? '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' : '–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç'}
      </Text>
      {!searchQuery && (
        <Text style={[styles.emptySubtext, { color: theme.textTertiary }]}>
          –°–æ–∑–¥–∞–π –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ó–∞–∫–∞–∑"
        </Text>
      )}
    </View>
  );

  const renderItem = ({ item }) => (
    <OrderCard
      order={item}
      theme={theme}
      onPress={() => showOrderDetails(item)}
    />
  );

  return (
    <SafeAreaView style={[styles.container, { backgroundColor: theme.background }]} edges={['top']}>
      <View style={styles.content}>
        {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
        <View style={styles.header}>
          <Ionicons name="list" size={28} color={theme.primary} />
          <Text style={[styles.title, { color: theme.text }]}>–ò—Å—Ç–æ—Ä–∏—è</Text>
        </View>

        {/* –ü–æ–∏—Å–∫ */}
        <Searchbar
          placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É, –∞–≤—Ç–æ, —Ä–∞–±–æ—Ç–µ..."
          onChangeText={handleSearch}
          value={searchQuery}
          style={[styles.searchBar, { backgroundColor: theme.surface }]}
          inputStyle={[styles.searchInput, { color: theme.text }]}
          iconColor={theme.primary}
          placeholderTextColor={theme.textTertiary}
          theme={{ colors: { primary: theme.primary } }}
        />

        {/* –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ */}
        <FlatList
          data={filteredOrders}
          renderItem={renderItem}
          keyExtractor={(item) => item.id}
          ListEmptyComponent={renderEmpty}
          refreshControl={
            <RefreshControl
              refreshing={refreshing}
              onRefresh={onRefresh}
              tintColor={theme.primary}
              colors={[theme.primary]}
            />
          }
          contentContainerStyle={styles.listContent}
          showsVerticalScrollIndicator={false}
        />

        {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π */}
        <Portal>
          <Modal
            visible={modalVisible}
            onDismiss={() => setModalVisible(false)}
            contentContainerStyle={[styles.modalContent, { backgroundColor: theme.surface }]}
          >
            {selectedOrder && (
              <View>
                <View style={styles.modalHeader}>
                  <Text style={[styles.modalTitle, { color: theme.primary }]}>
                    –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
                  </Text>
                  <TouchableOpacity onPress={() => handleDeleteOrder(selectedOrder)}>
                    <Ionicons name="trash-outline" size={24} color={theme.error} />
                  </TouchableOpacity>
                </View>
                
                <Divider style={[styles.divider, { backgroundColor: theme.border }]} />

                <View style={styles.detailRow}>
                  <Text style={[styles.detailLabel, { color: theme.textSecondary }]}>–î–∞—Ç–∞:</Text>
                  <Text style={[styles.detailValue, { color: theme.text }]}>
                    {selectedOrder.date}
                  </Text>
                </View>

                <View style={styles.detailRow}>
                  <Text style={[styles.detailLabel, { color: theme.textSecondary }]}>–ö–ª–∏–µ–Ω—Ç:</Text>
                  <Text style={[styles.detailValue, { color: theme.text }]}>
                    {selectedOrder.client}
                  </Text>
                </View>

                {selectedOrder.car && (
                  <View style={styles.detailRow}>
                    <Text style={[styles.detailLabel, { color: theme.textSecondary }]}>–ê–≤—Ç–æ:</Text>
                    <Text style={[styles.detailValue, { color: theme.text }]}>
                      {selectedOrder.car}
                    </Text>
                  </View>
                )}

                <View style={styles.detailRow}>
                  <Text style={[styles.detailLabel, { color: theme.textSecondary }]}>–†–∞–±–æ—Ç–∞:</Text>
                  <Text style={[styles.detailValue, { color: theme.text }]}>
                    {selectedOrder.job}
                  </Text>
                </View>

                <View style={styles.detailRow}>
                  <Text style={[styles.detailLabel, { color: theme.textSecondary }]}>–°—É–º–º–∞:</Text>
                  <Text style={[styles.detailValue, styles.amountText, { color: theme.primary }]}>
                    {formatAmount(selectedOrder.amount)}
                  </Text>
                </View>

                <View style={styles.detailRow}>
                  <Text style={[styles.detailLabel, { color: theme.textSecondary }]}>–û–ø–ª–∞—Ç–∞:</Text>
                  <Text style={[styles.detailValue, { color: theme.text }]}>
                    {getPayTypeText(selectedOrder.payType)}
                  </Text>
                </View>

                {selectedOrder.parts && (
                  <View style={styles.detailRow}>
                    <Text style={[styles.detailLabel, { color: theme.textSecondary }]}>–î–µ—Ç–∞–ª–∏:</Text>
                    <Text style={[styles.detailValue, { color: theme.text }]}>
                      {selectedOrder.parts}
                    </Text>
                  </View>
                )}

                {selectedOrder.freonGrams && (
                  <View style={styles.detailRow}>
                    <Text style={[styles.detailLabel, { color: theme.textSecondary }]}>–§—Ä–µ–æ–Ω:</Text>
                    <Text style={[styles.detailValue, { color: theme.text }]}>
                      {selectedOrder.freonGrams} –≥
                    </Text>
                  </View>
                )}

                {selectedOrder.comment && (
                  <View style={styles.detailRow}>
                    <Text style={[styles.detailLabel, { color: theme.textSecondary }]}>
                      –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:
                    </Text>
                    <Text style={[styles.detailValue, { color: theme.text }]}>
                      {selectedOrder.comment}
                    </Text>
                  </View>
                )}

                <Button
                  mode="outlined"
                  onPress={() => setModalVisible(false)}
                  style={styles.closeButton}
                  textColor={theme.textSecondary}
                >
                  –ó–∞–∫—Ä—ã—Ç—å
                </Button>
              </View>
            )}
          </Modal>
        </Portal>

        {/* Snackbar –¥–ª—è Undo */}
        <Snackbar
          visible={snackbarVisible}
          onDismiss={() => {
            setSnackbarVisible(false);
            setCurrentSnapshotId(null);
          }}
          duration={5000}
          action={{
            label: '–û—Ç–º–µ–Ω–∏—Ç—å',
            onPress: handleUndo,
          }}
          style={{ backgroundColor: theme.surface }}
          theme={{ colors: { surface: theme.surface, accent: theme.primary } }}
        >
          <Text style={{ color: theme.text }}>–ó–∞–∫–∞–∑ —É–¥–∞–ª—ë–Ω</Text>
        </Snackbar>
      </View>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  content: {
    flex: 1,
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: spacing.lg,
    paddingTop: spacing.md,
    paddingBottom: spacing.sm,
    gap: spacing.md,
  },
  title: {
    fontSize: 28,
    fontWeight: '700',
  },
  searchBar: {
    marginHorizontal: spacing.lg,
    marginBottom: spacing.md,
    elevation: 0,
    borderRadius: borderRadius.lg,
  },
  searchInput: {
    fontSize: fontSize.md,
  },
  listContent: {
    paddingBottom: 100,
    flexGrow: 1,
  },
  emptyState: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    paddingVertical: 60,
  },
  emptyText: {
    fontSize: fontSize.xl,
    fontWeight: '600',
    marginTop: spacing.lg,
  },
  emptySubtext: {
    fontSize: fontSize.md,
    marginTop: spacing.sm,
  },
  modalContent: {
    margin: spacing.xl,
    padding: spacing.xl,
    borderRadius: borderRadius.lg,
    maxHeight: '80%',
  },
  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: spacing.md,
  },
  modalTitle: {
    fontSize: fontSize.xxl,
    fontWeight: '700',
  },
  divider: {
    marginBottom: spacing.lg,
  },
  detailRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    paddingVertical: spacing.sm,
    gap: spacing.md,
  },
  detailLabel: {
    fontSize: fontSize.md,
    fontWeight: '600',
  },
  detailValue: {
    fontSize: fontSize.md,
    flex: 1,
    textAlign: 'right',
  },
  amountText: {
    fontWeight: '700',
    fontSize: fontSize.xl,
  },
  closeButton: {
    marginTop: spacing.lg,
  },
});
