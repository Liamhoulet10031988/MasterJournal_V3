import React, { useState, useEffect } from 'react';
import {
  View,
  ScrollView,
  StyleSheet,
  Alert,
  KeyboardAvoidingView,
  Platform,
  TouchableOpacity,
  Text,
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { TextInput, Button, RadioButton } from 'react-native-paper';
import { Ionicons } from '@expo/vector-icons';
import * as Haptics from 'expo-haptics';
import { useAppStore } from '../store/AppStore';
import { validateOrder } from '../utils/validators';
import { darkTheme, lightTheme, spacing, borderRadius, fontSize } from '../utils/theme';

const QUICK_JOBS = [
  { name: '–ó–∞–ø—Ä–∞–≤–∫–∞ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞', price: 1500 },
  { name: '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞', price: 500 },
  { name: '–ó–∞–º–µ–Ω–∞ –º–∞—Å–ª–∞', price: 800 },
  { name: '–†–µ–º–æ–Ω—Ç —Å—Ç–∞—Ä—Ç–µ—Ä–∞', price: 2000 },
  { name: '–ó–∞–º–µ–Ω–∞ —Å–≤–µ—á–µ–π', price: 1000 },
  { name: '–ó–∞–º–µ–Ω–∞ –ê–ö–ë', price: 1200 },
];

export default function HomeScreen() {
  const { addOrder, searchClients, searchCars, theme: themeMode } = useAppStore();
  const theme = themeMode === 'dark' ? darkTheme : lightTheme;

  const [client, setClient] = useState('');
  const [car, setCar] = useState('');
  const [job, setJob] = useState('');
  const [amount, setAmount] = useState('');
  const [payType, setPayType] = useState('cash');
  const [parts, setParts] = useState('');
  const [freonGrams, setFreonGrams] = useState('');
  const [comment, setComment] = useState('');

  const [clientSuggestions, setClientSuggestions] = useState([]);
  const [carSuggestions, setCarSuggestions] = useState([]);
  const [showClientSuggestions, setShowClientSuggestions] = useState(false);
  const [showCarSuggestions, setShowCarSuggestions] = useState(false);
  const [saving, setSaving] = useState(false);

  // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
  useEffect(() => {
    const fetchSuggestions = async () => {
      if (client.length >= 2) {
        const results = await searchClients(client);
        setClientSuggestions(results);
      } else {
        setClientSuggestions([]);
      }
    };
    fetchSuggestions();
  }, [client]);

  // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –∞–≤—Ç–æ
  useEffect(() => {
    const fetchSuggestions = async () => {
      if (car.length >= 2) {
        const results = await searchCars(car);
        setCarSuggestions(results);
      } else {
        setCarSuggestions([]);
      }
    };
    fetchSuggestions();
  }, [car]);

  const selectQuickJob = (jobItem) => {
    setJob(jobItem.name);
    setAmount(jobItem.price.toString());
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
  };

  const handleSave = async () => {
    const orderData = {
      date: new Date().toISOString().split('T')[0],
      client: client.trim(),
      car: car.trim(),
      job: job.trim(),
      amount: parseInt(amount) || 0,
      payType,
      parts: parts.trim(),
      freonGrams: freonGrams ? parseInt(freonGrams) : null,
      comment: comment.trim(),
    };

    const { isValid, errors } = validateOrder(orderData);

    if (!isValid) {
      const errorMessages = Object.values(errors).join('\n');
      Alert.alert('‚ùå –û—à–∏–±–∫–∞', errorMessages);
      Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error);
      return;
    }

    try {
      setSaving(true);
      await addOrder(orderData);
      
      // –£—Å–ø–µ—Ö - —Ö–∞–ø—Ç–∏–∫–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);
      Alert.alert('‚úÖ –£—Å–ø–µ—Ö', '–ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');

      // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
      setClient('');
      setCar('');
      setJob('');
      setAmount('');
      setPayType('cash');
      setParts('');
      setFreonGrams('');
      setComment('');
    } catch (error) {
      Alert.alert('‚ùå –û—à–∏–±–∫–∞', error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–∫–∞–∑');
      Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error);
    } finally {
      setSaving(false);
    }
  };

  return (
    <SafeAreaView style={[styles.container, { backgroundColor: theme.background }]} edges={['top']}>
      <KeyboardAvoidingView
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
        style={styles.keyboardView}
      >
        <ScrollView
          contentContainerStyle={styles.scrollContent}
          keyboardShouldPersistTaps="handled"
          showsVerticalScrollIndicator={false}
        >
          {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
          <View style={styles.header}>
            <Ionicons name="flash" size={28} color={theme.primary} />
            <Text style={[styles.title, { color: theme.text }]}>–ë—ã—Å—Ç—Ä—ã–π –∑–∞–∫–∞–∑</Text>
          </View>

          {/* –ö–ª–∏–µ–Ω—Ç */}
          <View style={styles.inputContainer}>
            <TextInput
              label="–ö–ª–∏–µ–Ω—Ç *"
              value={client}
              onChangeText={setClient}
              onFocus={() => setShowClientSuggestions(true)}
              onBlur={() => setTimeout(() => setShowClientSuggestions(false), 200)}
              style={[styles.input, { backgroundColor: theme.surface }]}
              mode="outlined"
              outlineColor={theme.border}
              activeOutlineColor={theme.primary}
              textColor={theme.text}
              theme={{ colors: { placeholder: theme.textTertiary } }}
            />
            {showClientSuggestions && clientSuggestions.length > 0 && (
              <View style={[styles.suggestions, { backgroundColor: theme.surface }]}>
                {clientSuggestions.map((suggestion, index) => (
                  <TouchableOpacity
                    key={index}
                    style={[styles.suggestionItem, { borderBottomColor: theme.border }]}
                    onPress={() => {
                      setClient(suggestion);
                      setShowClientSuggestions(false);
                      Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
                    }}
                  >
                    <Ionicons name="person-outline" size={16} color={theme.textSecondary} />
                    <Text style={[styles.suggestionText, { color: theme.text }]}>
                      {suggestion}
                    </Text>
                  </TouchableOpacity>
                ))}
              </View>
            )}
          </View>

          {/* –ê–≤—Ç–æ */}
          <View style={styles.inputContainer}>
            <TextInput
              label="–ú–∞—à–∏–Ω–∞"
              value={car}
              onChangeText={setCar}
              onFocus={() => setShowCarSuggestions(true)}
              onBlur={() => setTimeout(() => setShowCarSuggestions(false), 200)}
              style={[styles.input, { backgroundColor: theme.surface }]}
              mode="outlined"
              outlineColor={theme.border}
              activeOutlineColor={theme.primary}
              textColor={theme.text}
              placeholder="Lada Priora"
              theme={{ colors: { placeholder: theme.textTertiary } }}
            />
            {showCarSuggestions && carSuggestions.length > 0 && (
              <View style={[styles.suggestions, { backgroundColor: theme.surface }]}>
                {carSuggestions.map((suggestion, index) => (
                  <TouchableOpacity
                    key={index}
                    style={[styles.suggestionItem, { borderBottomColor: theme.border }]}
                    onPress={() => {
                      setCar(suggestion);
                      setShowCarSuggestions(false);
                      Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
                    }}
                  >
                    <Ionicons name="car-sport-outline" size={16} color={theme.textSecondary} />
                    <Text style={[styles.suggestionText, { color: theme.text }]}>
                      {suggestion}
                    </Text>
                  </TouchableOpacity>
                ))}
              </View>
            )}
          </View>

          {/* –ë—ã—Å—Ç—Ä—ã–µ —Ä–∞–±–æ—Ç—ã */}
          <Text style={[styles.sectionTitle, { color: theme.textSecondary }]}>
            –ë—ã—Å—Ç—Ä—ã–µ —Ä–∞–±–æ—Ç—ã:
          </Text>
          <View style={styles.quickJobs}>
            {QUICK_JOBS.map((jobItem, index) => (
              <TouchableOpacity
                key={index}
                style={[styles.quickJobChip, { 
                  backgroundColor: theme.surfaceHighlight,
                  borderColor: theme.border,
                }]}
                onPress={() => selectQuickJob(jobItem)}
                activeOpacity={0.7}
              >
                <Ionicons name="flash" size={14} color={theme.primary} />
                <Text style={[styles.quickJobText, { color: theme.text }]}>
                  {jobItem.name}
                </Text>
                <Text style={[styles.quickJobPrice, { color: theme.primary }]}>
                  {jobItem.price}‚ÇΩ
                </Text>
              </TouchableOpacity>
            ))}
          </View>

          {/* –†–∞–±–æ—Ç–∞ */}
          <TextInput
            label="–†–∞–±–æ—Ç–∞ *"
            value={job}
            onChangeText={setJob}
            style={[styles.input, { backgroundColor: theme.surface }]}
            mode="outlined"
            outlineColor={theme.border}
            activeOutlineColor={theme.primary}
            textColor={theme.text}
            multiline
            numberOfLines={2}
            theme={{ colors: { placeholder: theme.textTertiary } }}
          />

          {/* –°—É–º–º–∞ */}
          <TextInput
            label="–°—É–º–º–∞, ‚ÇΩ *"
            value={amount}
            onChangeText={setAmount}
            keyboardType="numeric"
            style={[styles.input, { backgroundColor: theme.surface }]}
            mode="outlined"
            outlineColor={theme.border}
            activeOutlineColor={theme.primary}
            textColor={theme.text}
            theme={{ colors: { placeholder: theme.textTertiary } }}
          />

          {/* –û–ø–ª–∞—Ç–∞ */}
          <Text style={[styles.sectionTitle, { color: theme.textSecondary }]}>
            –û–ø–ª–∞—Ç–∞:
          </Text>
          <RadioButton.Group onValueChange={setPayType} value={payType}>
            <View style={[styles.radioContainer, { backgroundColor: theme.surface }]}>
              <TouchableOpacity
                style={styles.radioItem}
                onPress={() => {
                  setPayType('cash');
                  Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
                }}
              >
                <RadioButton value="cash" color={theme.cash} />
                <Text style={[styles.radioLabel, { color: theme.text }]}>üíµ –ù–∞–ª</Text>
              </TouchableOpacity>
              
              <TouchableOpacity
                style={styles.radioItem}
                onPress={() => {
                  setPayType('cashless');
                  Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
                }}
              >
                <RadioButton value="cashless" color={theme.cashless} />
                <Text style={[styles.radioLabel, { color: theme.text }]}>üí≥ –ë–µ–∑–Ω–∞–ª</Text>
              </TouchableOpacity>
              
              <TouchableOpacity
                style={styles.radioItem}
                onPress={() => {
                  setPayType('debt');
                  Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
                }}
              >
                <RadioButton value="debt" color={theme.debt} />
                <Text style={[styles.radioLabel, { color: theme.text }]}>‚ö†Ô∏è –î–æ–ª–≥</Text>
              </TouchableOpacity>
            </View>
          </RadioButton.Group>

          {/* –î–µ—Ç–∞–ª–∏ */}
          <TextInput
            label="–î–µ—Ç–∞–ª–∏ (–µ—Å–ª–∏ –ø–æ–∫—É–ø–∞–ª)"
            value={parts}
            onChangeText={setParts}
            style={[styles.input, { backgroundColor: theme.surface }]}
            mode="outlined"
            outlineColor={theme.border}
            activeOutlineColor={theme.primary}
            textColor={theme.text}
            placeholder="–§–∏–ª—å—Ç—Ä, –º–∞—Å–ª–æ..."
            theme={{ colors: { placeholder: theme.textTertiary } }}
          />

          {/* –§—Ä–µ–æ–Ω */}
          <TextInput
            label="–ì—Ä–∞–º–º—ã —Ñ—Ä–µ–æ–Ω–∞"
            value={freonGrams}
            onChangeText={setFreonGrams}
            keyboardType="numeric"
            style={[styles.input, { backgroundColor: theme.surface }]}
            mode="outlined"
            outlineColor={theme.border}
            activeOutlineColor={theme.primary}
            textColor={theme.text}
            placeholder="250"
            theme={{ colors: { placeholder: theme.textTertiary } }}
          />

          {/* –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π */}
          <TextInput
            label="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
            value={comment}
            onChangeText={setComment}
            style={[styles.input, { backgroundColor: theme.surface }]}
            mode="outlined"
            outlineColor={theme.border}
            activeOutlineColor={theme.primary}
            textColor={theme.text}
            multiline
            numberOfLines={3}
            theme={{ colors: { placeholder: theme.textTertiary } }}
          />

          {/* –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è */}
          <Button
            mode="contained"
            onPress={handleSave}
            style={[styles.saveButton, { backgroundColor: theme.primary }]}
            contentStyle={styles.buttonContent}
            labelStyle={[styles.buttonLabel, { color: theme.background }]}
            icon="check-circle"
            loading={saving}
            disabled={saving}
          >
            {saving ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–∫–∞–∑'}
          </Button>
        </ScrollView>
      </KeyboardAvoidingView>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  keyboardView: {
    flex: 1,
  },
  scrollContent: {
    padding: spacing.lg,
    paddingBottom: 100,
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: spacing.xl,
    gap: spacing.md,
  },
  title: {
    fontSize: 28,
    fontWeight: '700',
  },
  sectionTitle: {
    fontSize: fontSize.md,
    fontWeight: '600',
    marginTop: spacing.md,
    marginBottom: spacing.sm,
  },
  inputContainer: {
    marginBottom: spacing.md,
    position: 'relative',
  },
  input: {
    marginBottom: spacing.md,
  },
  suggestions: {
    position: 'absolute',
    top: 58,
    left: 0,
    right: 0,
    borderRadius: borderRadius.md,
    zIndex: 1000,
    elevation: 8,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.3,
    shadowRadius: 8,
  },
  suggestionItem: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: spacing.md,
    gap: spacing.sm,
    borderBottomWidth: 1,
  },
  suggestionText: {
    fontSize: fontSize.md,
    flex: 1,
  },
  quickJobs: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: spacing.sm,
    marginBottom: spacing.lg,
  },
  quickJobChip: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: spacing.md,
    paddingVertical: spacing.sm,
    borderRadius: borderRadius.md,
    borderWidth: 1,
    gap: spacing.xs,
  },
  quickJobText: {
    fontSize: fontSize.sm,
    fontWeight: '500',
  },
  quickJobPrice: {
    fontSize: fontSize.sm,
    fontWeight: '700',
  },
  radioContainer: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    padding: spacing.md,
    borderRadius: borderRadius.lg,
    marginBottom: spacing.lg,
  },
  radioItem: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  radioLabel: {
    fontSize: fontSize.md,
    marginLeft: spacing.xs,
    fontWeight: '500',
  },
  saveButton: {
    marginTop: spacing.xl,
    borderRadius: borderRadius.lg,
  },
  buttonContent: {
    paddingVertical: spacing.sm,
  },
  buttonLabel: {
    fontSize: fontSize.lg,
    fontWeight: '700',
  },
});
